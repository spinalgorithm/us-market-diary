=== FETCH RUN START === Sat Sep 13 18:36:19 UTC 2025
== PWD ==
/home/runner/work/us-market-diary/us-market-diary
== BRANCH ==
main
== TREE (top) ==
total 52
drwxr-xr-x 7 runner runner 4096 Sep 13 18:36 .
drwxr-xr-x 3 runner runner 4096 Sep 13 18:36 ..
drwxr-xr-x 7 runner runner 4096 Sep 13 18:36 .git
drwxr-xr-x 3 runner runner 4096 Sep 13 18:36 .github
-rw-r--r-- 1 runner runner 1038 Sep 13 18:36 README.md
-rw-r--r-- 1 runner runner  148 Sep 13 18:36 fetch.log
-rw-r--r-- 1 runner runner  397 Sep 13 18:36 package.json
drwxr-xr-x 2 runner runner 4096 Sep 13 18:36 public
drwxr-xr-x 2 runner runner 4096 Sep 13 18:36 scripts
drwxr-xr-x 3 runner runner 4096 Sep 13 18:36 src
-rw-r--r-- 1 runner runner  470 Sep 13 18:36 tsconfig.json
-rw-r--r-- 1 runner runner  280 Sep 13 18:36 tsconfig.scripts.json
-rw-r--r-- 1 runner runner  148 Sep 13 18:36 vercel.json
== TREE (.github/workflows) ==
total 12
drwxr-xr-x 2 runner runner 4096 Sep 13 18:36 .
drwxr-xr-x 3 runner runner 4096 Sep 13 18:36 ..
-rw-r--r-- 1 runner runner 3165 Sep 13 18:36 fetch-jpx.yml
== TREE (scripts) ==
total 16
drwxr-xr-x 2 runner runner 4096 Sep 13 18:36 .
drwxr-xr-x 7 runner runner 4096 Sep 13 18:36 ..
-rw-r--r-- 1 runner runner 5550 Sep 13 18:36 fetch_jpx_full.ts
== TREE (public) ==
total 12
drwxr-xr-x 2 runner runner 4096 Sep 13 18:36 .
drwxr-xr-x 7 runner runner 4096 Sep 13 18:36 ..
-rw-r--r-- 1 runner runner 4085 Sep 13 18:36 jpx_universe.csv
== SHOW package.json ==
{
  "name": "us-market-diary",
  "private": true,
  "type": "module",
  "scripts": {
    "build": "next build",
    "start": "next start",
    "dev": "next dev",
    "fetch:jpx": "npx -y ts-node@10.9.2 --esm scripts/fetch_jpx_full.ts --limit=5000"
  },
  "dependencies": {
    "next": "14.2.5",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "openai": "^4.0.0",
    "luxon": "^3.4.4"
  }
}
== SHOW scripts/fetch_jpx_full.ts (1..120) ==
// scripts/fetch_jpx_full.ts
// 목적: Twelve Data /stocks에서 일본 종목을 페이지네이션으로 전부 수집해
//       public/jpx_universe.csv 로 저장.
// 실행: npm run fetch:jpx  (GitHub Actions에서 TWELVEDATA_API_KEY로 실행됨)

import { writeFile } from "node:fs/promises";

type TDStock = {
  symbol: string;      // 예: "7203", "8035.T", "7203:JP" 등
  name: string;        // 종목명
  currency?: string;   // "JPY" 등
  exchange?: string;   // "TSE" 등
  country?: string;    // "Japan"
  type?: string;       // "Common Stock", "ETF", "REIT" 등
};

type TDStocksResponse =
  | { data: TDStock[]; status?: string }
  | { status: "error"; message?: string }
  | any;

const API_KEY = process.env.TWELVEDATA_API_KEY ?? "";
if (!API_KEY) {
  console.warn("[warn] TWELVEDATA_API_KEY is empty. You can still try, but quota may be tiny.");
}

// ---- 설정값(필요시 조정) ----
const LIMIT = Number(process.argv.find(a => a.startsWith("--limit="))?.split("=")[1] ?? "5000");
const INCLUDE_TYPES = new Set(["Common Stock", "ETF", "REIT"]); // 필요시 "Fund" 등 추가
const COUNTRY = "Japan";     // 일본만
// exchange 필터를 너무 좁히면 누락될 수 있어 country만으로 먼저 긁고, 후처리로 정제합니다.
const MAX_PAGES = 500;       // 안전 상한
const PAGE_PAUSE_MS = 250;   // 페이지 사이 살짝 딜레이(레이트 제한 방지)

// ---- 유틸 ----
const sleep = (ms: number) => new Promise(res => setTimeout(res, ms));

// 12Data /stocks 페이지 단위 요청
async function fetchPage(page: number): Promise<TDStock[]> {
  const url = new URL("https://api.twelvedata.com/stocks");
  url.searchParams.set("country", COUNTRY);
  url.searchParams.set("page", String(page));
  url.searchParams.set("apikey", API_KEY);
  // 필요시 exchange를 추가로 좁혀보고 싶다면:
  // url.searchParams.set("exchange", "TSE"); // 누락 생기면 주석 처리하세요.

  const r = await fetch(url.toString(), { cache: "no-store" });
  if (!r.ok) {
    console.warn(`[warn] /stocks page=${page} http=${r.status}`);
    return [];
  }
  const j = (await r.json()) as TDStocksResponse;
  if (!j || (j.status === "error")) {
    console.warn(`[warn] /stocks page=${page} api-error: ${(j as any)?.message ?? ""}`);
    return [];
  }
  const arr = (j as any).data as TDStock[] | undefined;
  if (!Array.isArray(arr)) return [];
  return arr;
}

// 심볼에서 JP 코드/야후심볼 추출
function normalizeSymbol(s: string) {
  // 다양한 패턴 대응: "8035", "8035.T", "8035:JP", "8035.TOKYO" 등 가능성
  // 1) 숫자만 추출(선행 숫자 덩어리)
  const m = s.match(/^(\d{3,5})/);
  const code = m ? m[1] : s.replace(/[:.].*$/, "");

  // 2) 야후 심볼로 통일
  //    이미 *.T 이면 그대로, 아니면 "<code>.T"
  const yahoo =
    /\.T$/i.test(s) ? s.toUpperCase() :
    `${code}.T`;

  return { code, yahooSymbol: yahoo };
}

// CSV 행 포맷
type CSVRow = {
  code: string;
  name: string;
  theme: string;       // 비워두면 "-" (추후 수동 보강 가능)
  brief: string;       // 비워두면 "-"
  yahooSymbol: string;
};

function toCSV(rows: CSVRow[]): string {
  const header = ["code", "name", "theme", "brief", "yahooSymbol"];
  const lines = [header.join(",")];
  for (const r of rows) {
    // 아주 단순 CSV (필드에 쉼표가 거의 없다고 가정; 필요시 더 견고한 CSV 인코딩 적용)
    lines.push(
      [r.code, r.name ?? "", r.theme ?? "-", r.brief ?? "-", r.yahooSymbol].map(v =>
        /[",\n]/.test(v) ? `"${v.replace(/"/g, '""')}"` : v
      ).join(",")
    );
  }
  return lines.join("\n") + "\n";
}

async function main() {
  console.log(`[info] Start fetch JP stocks from Twelve Data /stocks, LIMIT=${LIMIT}`);
  let all: TDStock[] = [];
  for (let p = 1; p <= MAX_PAGES; p++) {
    const arr = await fetchPage(p);
    console.log(`[info] page ${p}: ${arr.length} items`);
    if (arr.length === 0) break;
    all = all.concat(arr);
    await sleep(PAGE_PAUSE_MS);
    if (all.length > LIMIT * 3) {
      // 비정상 폭주 방지
      break;
    }
  }
  console.log(`[info] raw fetched: ${all.length}`);

  // 1) 국가/통화 정제
  const jpy = all.filter(x =>
    (x.country?.toLowerCase() === "japan") &&
    (!x.currency || x.currency.toUpperCase() === "JPY")
NO MJS SCRIPT
== Node/NPM versions ==
v20.19.5
10.8.2
== CSV HEAD ==
ticker,name,theme,brief
1321.T,日経225連動型上場投信,インデックス/ETF,日経225連動ETF
1306.T,TOPIX連動型上場投信,インデックス/ETF,TOPIX連動ETF
7203.T,トヨタ自動車,自動車,世界最大級の自動車メーカー
6758.T,ソニーグループ,エレクトロニクス,ゲーム/画像センサー/音楽
== CSV TAIL ==
9984.T,ソフトバンクグループ,投資/テック,投資持株/通信
9983.T,ファーストリテイリング,アパレル/SPA,ユニクロ
9432.T,NTT,通信,国内通信大手
9433.T,KDDI,通信,au/通信
9434.T,ソフトバンク,通信,携帯通信
== ROW COUNT ==
72 public/jpx_universe.csv
